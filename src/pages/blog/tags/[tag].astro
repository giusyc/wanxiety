---
import { getCollection } from 'astro:content';
import type { CollectionEntry } from 'astro:content';
import Layout from '@layouts/Default.astro';
import BlogList from '@components/blog/BlogList.astro';
import { Button } from '@eliancodes/brutal-ui';

export async function getStaticPaths() {
  const allPosts = await getCollection('blog').then((collection) =>
    collection.reverse()
  );

  const tags: string[] = [];

  allPosts.forEach((post) => {
    // Some posts don't have tags — guard against undefined
    const postTags = Array.isArray(post.data.tags) ? post.data.tags : [];
    postTags.forEach((tag) => {
      tags.push(tag.toLowerCase());
    });
  });

  // Use different variable names to avoid shadowing `tag` inside inner scopes
  return Array.from(new Set(tags)).map((tagName) => {
    return {
      params: { tag: tagName },
      props: {
        tag: tagName,
        blogposts: allPosts.filter((post) => {
          const postTags = Array.isArray(post.data.tags) ? post.data.tags : [];
          return postTags.map((t) => t.toLowerCase()).includes(tagName);
        }),
      },
    };
  });
}

interface Props {
  tag?: string;
  blogposts?: CollectionEntry<'blog'>[];
}

// Support both prerender (Astro.props) _and_ dynamic/runtime using Astro.params
const { tag: propTag, blogposts: propBlogposts } = Astro.props ?? {};
const currentTag = propTag ?? Astro.params?.tag;

// If blogposts were provided by getStaticPaths props, use them; otherwise compute them now
let blogposts: CollectionEntry<'blog'>[] = Array.isArray(propBlogposts)
  ? propBlogposts
  : [];

if (!Array.isArray(blogposts) || blogposts.length === 0) {
  // compute posts using the tag param at runtime
  const allPosts = await getCollection('blog').then((collection) => collection.reverse());
  blogposts = allPosts.filter((post) => {
    const postTags = Array.isArray(post.data.tags) ? post.data.tags : [];
    return postTags.map((t) => t.toLowerCase()).includes(String(currentTag).toLowerCase());
  });
}

// Safe display value for templates
const displayTag = currentTag ? String(currentTag) : '';
---

<Layout
  title={`Blog: ${displayTag}`}
  description={`Bye Wanxiety | All podcasts tagged with ${displayTag}`}
  pageTitle={`Podcasts & Meditations | Podcasts tagged with ${displayTag}`}
>
  <main class='p-6 bg-purple grid gap-4'>
    <div>
      <Button href='/blog/'>&larr; Back to Episodes & Meditations </Button>
    </div>
    <BlogList posts={blogposts} />
  </main>
</Layout>
